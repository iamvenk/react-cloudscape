<!doctype html>
<html lang="en">
  <head>
    <title>TODO: Update Title</title>
    <script type="text/javascript">
        // TODO: Update the URLs
        // URL to load the document list
        var docListUrl = "";
        var docDetailsUrl = ""
        var dataReloadInterval = 5000; //milliseconds
        var tableDocList = null;
        var tableDocDetails = null;
    </script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link href="https://getbootstrap.com/docs/4.0/examples/sticky-footer-navbar/" rel="canonical">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://getbootstrap.com/docs/4.0/examples/sticky-footer-navbar/sticky-footer-navbar.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.1/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="http://cdn.datatables.net/1.13.1/css/jquery.dataTables.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/select/1.5.0/css/select.dataTables.min.css" rel="stylesheet">

  </head>
  
  <body>

    <header class="bg-dark">
      <div class="position-absolute top-0 start-0">
        <a class="fw-bold" style="color: white; text-decoration: none;" href="#"></a>
      </div>
      <ul class="nav justify-content-center p-2">
        <li class="nav-item">
          <a class="btn btn-primary" href="#">Total Docs <span class="badge text-bg-light" id="spanRecordCount"></span></a>
        </li>
      </ul>
    </header>

    <!-- Begin page content -->
    <main role="main" class="container">
      <table id="tableDocList" class="table table-striped table-bordered" style="width: 100%;">
        <thead>
        </thead>
        <tbody>
        </tbody>
    </table>
    </main>

    <!-- Modal -->
    <div class="modal fade" id="modalDocDetails" tabindex="-1" aria-labelledby="modalDocDetailsLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="modalDocDetailsLabel">Document Details</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="container">
              <div class="row text-secondary">
                <div class="col">Score </div>
                <div class="col">Type</div>
                <div class="col">Status</div>
              </div>
              <div class="row text-primary">
                <div class="col" id="docScore"></div>
                <div class="col" id="docType"></div>
                <div class="col" id="docStatus"></div>
              </div>
              <div class="row">
              </div>
            </div>
            <table class="table" id="tblDocDetails">
              <thead>
                <th></th>
                <th></th>
              </thead>
              <tbody>
              </tbody>
            </table>
          </div>
          <div class="modal-footer">
            <p class="text-left text-secondary" id="docId">
            </p>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
   
    <footer class="footer">
      <div class="container">
        <span class="text-muted">TODO: Update Footer</span>
      </div>
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.2/moment.min.js"></script>
    <script>window.jQuery || document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.slim.js"><\/script>')</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.9.2/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/select/1.5.0/js/dataTables.select.min.js"></script>
    
    <script type="text/javascript">

      var colDefDocList = [
        {data: 'documentName', title: 'Name', width: "10%"},
        {data: 'documentType', title: 'Type', width: "10%"},
        {data: 'documentConfidenceScore', title: 'Score',     width: "5%"},
        {data: 'documentStatus',          title: 'Status',    width: "5%"},
        {data: 'documentCreatedOn',       title: 'Created On', width: "10%"},
        {data: 'documentClassificationCompletedOn', title: 'Completed On', width: "15%"}
        // {data: 'documentKey', title: 'Key', width: "25%"},
        // {data: 'documentId',  title: 'Id', width: "20%"}
      ];
      
      var colDefDocDetails = [
        {data: 'key', title: 'Key', width: "50%"},
        {data: 'value', title: 'Value', width: "50%"},
      ];

      $(document).ready(function(){

        tableDocList = $("#tableDocList").DataTable({
          ajax: {
            url: docListUrl,
            dataSrc: 'Items'
          },
          deferRender: true,
          columns: colDefDocList,         
          select: true,
          scrollX: true,
          autoWidth: false,
          drawCallback: function(settings, start, end, max, total, pre) {
            $('#spanRecordCount').text(this.fnSettings().fnRecordsTotal());
          }
        });

        tableDocList.on('select', function(e, dt, type, indexes) {
          
          console.log('Table select event ' + type);
          $('#modalDocDetails').modal('show');

          if(!(type==='row')) return;

          var selDocId = tableDocList.rows(indexes).data().pluck('documentId')[0];
          var urlToLoad = docDetailsUrl + selDocId;
          console.log(urlToLoad);

          $.get(urlToLoad, function(data) {

            if(data.Item == null) return;

            $('#modalDocDetailsLabel').text(data.Item.documentName);
            $('#docScore').text(data.Item.documentConfidenceScore);
            $('#docType').text(data.Item.documentType);
            $('#docStatus').text(data.Item.documentStatus);
            $('#docId').text('Doc Id: ' + data.Item.documentId);
            
            var formData = [];

            // Convert the formdata array of array element to object array
            $.each(JSON.parse(data.Item.formData), function(index, v) {
              if(v[0] != "Key") formData.push({key: v[0], value: v[1]});
            });

            tableDocDetails.clear().rows.add(formData).draw();

          } );

        });

        tableDocDetails = $("#tblDocDetails").DataTable({
          columns: colDefDocDetails,         
          select: true,
          scrollX: true,
          autoWidth: false,
          drawCallback: function(settings, start, end, max, total, pre) {
            
          }
        });

        // To reload the data in the doc list table
        setInterval(
          function() { 
            console.log('Reload doc list table ' + (new Date()).toLocaleString());
            tableDocList.ajax.reload();          
          },
          dataReloadInterval
        );

      });

    </script>
  </body>
</html>